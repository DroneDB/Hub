Nexus=function(){var e,r,t,o,n=document.getElementsByTagName("script");for(e=0;e<n.length;e++){var s=n[e].attributes;for(r=0;r<s.length;r++){var i=s[r];if("src"==i.name&&(i.value&&i.value.search("nexus.js")>=0)){o=i.value;break}}}var a=null;var u=null;function f(e){var r=e.getUint32(e.offset,!0),t=e.getUint32(e.offset+4,!0);return e.offset+=8,1*t+r}function c(e){var r=e.getUint32(e.offset,!0);return e.offset+=4,r}function l(e){var r=e.getUint16(e.offset,!0);return e.offset+=2,r}function d(e){var r=e.getFloat32(e.offset,!0);return e.offset+=4,r}function h(e,r){var t=1/(e[12]*e[9]*e[6]*e[3]-e[8]*e[13]*e[6]*e[3]-e[12]*e[5]*e[10]*e[3]+e[4]*e[13]*e[10]*e[3]+e[8]*e[5]*e[14]*e[3]-e[4]*e[9]*e[14]*e[3]-e[12]*e[9]*e[2]*e[7]+e[8]*e[13]*e[2]*e[7]+e[12]*e[1]*e[10]*e[7]-e[0]*e[13]*e[10]*e[7]-e[8]*e[1]*e[14]*e[7]+e[0]*e[9]*e[14]*e[7]+e[12]*e[5]*e[2]*e[11]-e[4]*e[13]*e[2]*e[11]-e[12]*e[1]*e[6]*e[11]+e[0]*e[13]*e[6]*e[11]+e[4]*e[1]*e[14]*e[11]-e[0]*e[5]*e[14]*e[11]-e[8]*e[5]*e[2]*e[15]+e[4]*e[9]*e[2]*e[15]+e[8]*e[1]*e[6]*e[15]-e[0]*e[9]*e[6]*e[15]-e[4]*e[1]*e[10]*e[15]+e[0]*e[5]*e[10]*e[15]);r[0]=(e[9]*e[14]*e[7]-e[13]*e[10]*e[7]+e[13]*e[6]*e[11]-e[5]*e[14]*e[11]-e[9]*e[6]*e[15]+e[5]*e[10]*e[15])*t,r[1]=(e[13]*e[10]*e[3]-e[9]*e[14]*e[3]-e[13]*e[2]*e[11]+e[1]*e[14]*e[11]+e[9]*e[2]*e[15]-e[1]*e[10]*e[15])*t,r[2]=(e[5]*e[14]*e[3]-e[13]*e[6]*e[3]+e[13]*e[2]*e[7]-e[1]*e[14]*e[7]-e[5]*e[2]*e[15]+e[1]*e[6]*e[15])*t,r[3]=(e[9]*e[6]*e[3]-e[5]*e[10]*e[3]-e[9]*e[2]*e[7]+e[1]*e[10]*e[7]+e[5]*e[2]*e[11]-e[1]*e[6]*e[11])*t,r[4]=(e[12]*e[10]*e[7]-e[8]*e[14]*e[7]-e[12]*e[6]*e[11]+e[4]*e[14]*e[11]+e[8]*e[6]*e[15]-e[4]*e[10]*e[15])*t,r[5]=(e[8]*e[14]*e[3]-e[12]*e[10]*e[3]+e[12]*e[2]*e[11]-e[0]*e[14]*e[11]-e[8]*e[2]*e[15]+e[0]*e[10]*e[15])*t,r[6]=(e[12]*e[6]*e[3]-e[4]*e[14]*e[3]-e[12]*e[2]*e[7]+e[0]*e[14]*e[7]+e[4]*e[2]*e[15]-e[0]*e[6]*e[15])*t,r[7]=(e[4]*e[10]*e[3]-e[8]*e[6]*e[3]+e[8]*e[2]*e[7]-e[0]*e[10]*e[7]-e[4]*e[2]*e[11]+e[0]*e[6]*e[11])*t,r[8]=(e[8]*e[13]*e[7]-e[12]*e[9]*e[7]+e[12]*e[5]*e[11]-e[4]*e[13]*e[11]-e[8]*e[5]*e[15]+e[4]*e[9]*e[15])*t,r[9]=(e[12]*e[9]*e[3]-e[8]*e[13]*e[3]-e[12]*e[1]*e[11]+e[0]*e[13]*e[11]+e[8]*e[1]*e[15]-e[0]*e[9]*e[15])*t,r[10]=(e[4]*e[13]*e[3]-e[12]*e[5]*e[3]+e[12]*e[1]*e[7]-e[0]*e[13]*e[7]-e[4]*e[1]*e[15]+e[0]*e[5]*e[15])*t,r[11]=(e[8]*e[5]*e[3]-e[4]*e[9]*e[3]-e[8]*e[1]*e[7]+e[0]*e[9]*e[7]+e[4]*e[1]*e[11]-e[0]*e[5]*e[11])*t,r[12]=(e[12]*e[9]*e[6]-e[8]*e[13]*e[6]-e[12]*e[5]*e[10]+e[4]*e[13]*e[10]+e[8]*e[5]*e[14]-e[4]*e[9]*e[14])*t,r[13]=(e[8]*e[13]*e[2]-e[12]*e[9]*e[2]+e[12]*e[1]*e[10]-e[0]*e[13]*e[10]-e[8]*e[1]*e[14]+e[0]*e[9]*e[14])*t,r[14]=(e[12]*e[5]*e[2]-e[4]*e[13]*e[2]-e[12]*e[1]*e[6]+e[0]*e[13]*e[6]+e[4]*e[1]*e[14]-e[0]*e[5]*e[14])*t,r[15]=(e[4]*e[9]*e[2]-e[8]*e[5]*e[2]+e[8]*e[1]*e[6]-e[0]*e[9]*e[6]-e[4]*e[1]*e[10]+e[0]*e[5]*e[10])*t}PriorityQueue=function(e){this.error=new Float32Array(e),this.data=new Int32Array(e),this.size=0},PriorityQueue.prototype={push:function(e,r){this.data[this.size]=e,this.error[this.size]=r,this.bubbleUp(this.size),this.size++},pop:function(){var e=this.data[0];return this.size--,this.size>0&&(this.data[0]=this.data[this.size],this.error[0]=this.error[this.size],this.sinkDown(0)),e},bubbleUp:function(e){for(var r=this.data[e],t=this.error[e];e>0;){var o=(e+1>>1)-1,n=this.error[o];if(n>t)break;this.data[e]=this.data[o],this.error[e]=n,this.data[o]=r,this.error[o]=t,e=o}},sinkDown:function(e){for(var r=this.data[e],t=this.error[e];;){var o=2*(e+1),n=o-1,s=-1;if(n<this.size){var i=this.error[n];i>t&&(s=n)}if(o<this.size)this.error[o]>(-1==s?t:i)&&(s=o);if(-1==s)break;this.data[e]=this.data[s],this.error[e]=this.error[s],this.data[s]=r,this.error[s]=t,e=s}}};var v={verbose:!1,nodes:!1,draw:!1,extract:!1},p=WebGLRenderingContext.prototype,m=[p.NONE,p.BYTE,p.UNSIGNED_BYTE,p.SHORT,p.UNSIGNED_SHORT,p.INT,p.UNSIGNED_INT,p.FLOAT,p.DOUBLE],x=[0,1,1,2,2,4,4,4,8],b=2,A=15,E=15,g=3,R=2,w=536870912;Mesh=function(){var e=this;e.onLoad=null,e.reqAttempt=0,e.georeq={},e.texreq={}},Mesh.prototype={open:function(r){var t=this;t.url=r,t.httpRequest({url:this.url,start:0,end:88,load:function(){v.verbose&&console.log("Loading header for "+t.url);var o=new DataView(this.response);o.offset=0,t.reqAttempt++;var n=t.importHeader(o);if(!n)return v.verbose&&console.log("Empty header!"),void(t.reqAttempt<R&&t.open(t.url+"?"+Math.random()));for(e in t.reqAttempt=0,n)t[e]=n[e];t.vertex=t.signature.vertex,t.face=t.signature.face,t.renderMode=t.face.index?["FILL","POINT"]:["POINT"],t.compressed=6&t.signature.flags,t.deepzoom=8&t.signature.flags,t.meco=2&t.signature.flags,t.corto=4&t.signature.flags,t.deepzoom&&(t.baseurl=r.substr(0,r.length-4)+"_files/"),t.requestIndex()},error:function(){console.log("Open request error!")},abort:function(){console.log("Open request abort!")},type:"arraybuffer"})},httpRequest:function({url:e,start:r,end:t,load:o,error:n,abort:s,type:i}){i||(i="arraybuffer");var a=new XMLHttpRequest;return a.open("GET",e,!0),a.responseType=i,t&&a.setRequestHeader("Range","bytes="+r+"-"+(t-1)),a.onload=function(){switch(this.status){case 0:case 206:o.bind(this)();break;case 200:this.deepzoom?console.log("200 response: server does not support byte range requests."):o.bind(this)()}},a.onerror=n,a.onabort=s,a.send(),a},requestIndex:function(){var e=this,r=88+44*e.nodesCount+12*e.patchesCount+68*e.texturesCount;e.httpRequest({url:this.url,start:88,end:r,load:function(){v.verbose&&console.log("Loading index for "+e.url),e.handleIndex(this.response)},error:function(){console.log("Index request error!")},abort:function(){console.log("Index request abort!")},type:"arraybuffer"})},handleIndex:function(e){var o=this,n=new DataView(e);n.offset=0;var s=o.nodesCount;for(o.noffsets=new Uint32Array(s),o.nvertices=new Uint32Array(s),o.nfaces=new Uint32Array(s),o.nerrors=new Float32Array(s),o.nspheres=new Float32Array(5*s),o.nsize=new Float32Array(s),o.nfirstpatch=new Uint32Array(s),u=0;u<s;u++){for(o.noffsets[u]=256*c(n),o.nvertices[u]=l(n),o.nfaces[u]=l(n),o.nerrors[u]=d(n),n.offset+=8,t=0;t<5;t++)o.nspheres[5*u+t]=d(n);o.nfirstpatch[u]=c(n)}for(o.sink=s-1,o.patches=new Uint32Array(n.buffer,n.offset,3*o.patchesCount),o.nroots=o.nodesCount,r=0;r<o.nroots;r++)for(u=o.nfirstpatch[r];u<o.nfirstpatch[r+1];u++)o.patches[3*u]<o.nroots&&(o.nroots=o.patches[3*u]);for(n.offset+=12*o.patchesCount,o.textures=new Uint32Array(o.texturesCount),o.texref=new Uint32Array(o.texturesCount),u=0;u<o.texturesCount;u++)o.textures[u]=256*c(n),n.offset+=64;o.vsize=12+(o.vertex.normal?6:0)+(o.vertex.color?4:0)+(o.vertex.texCoord?8:0),o.fsize=6;for(var i=new Uint32Array(s-1),a=new Uint32Array(s-1),u=0;u<s-1;u++){for(var f=o.nfirstpatch[u];f!=o.nfirstpatch[u+1];f++){var h=o.patches[3*f+2];i[u]+=o.textures[h+1]-o.textures[h],a[u]++}o.nsize[u]=o.vsize*o.nvertices[u]+o.fsize*o.nfaces[u]}for(u=0;u<s-1;u++)o.nsize[u]+=10*i[u]/a[u];o.status=new Uint8Array(s),o.frames=new Uint32Array(s),o.errors=new Float32Array(s),o.ibo=new Array(s),o.vbo=new Array(s),o.texids=new Array(s),o.isReady=!0,o.onLoad&&o.onLoad()},importAttribute:function(e){var r={};return r.type=e.getUint8(e.offset++,!0),r.size=e.getUint8(e.offset++,!0),r.glType=m[r.type],r.normalized=r.type<7,r.stride=x[r.type]*r.size,0==r.size?null:r},importElement:function(r){var t=[];for(e=0;e<8;e++)t[e]=this.importAttribute(r);return t},importVertex:function(e){var r=this.importElement(e),t=r[2];return t&&(t.type=2,t.glType=m[2]),{position:r[0],normal:r[1],color:r[2],texCoord:r[3],data:r[4]}},importFace:function(e){var r=this.importElement(e),t=r[2];return t&&(t.type=2,t.glType=m[2]),{index:r[0],normal:r[1],color:r[2],texCoord:r[3],data:r[4]}},importSignature:function(e){var r={};return r.vertex=this.importVertex(e),r.face=this.importFace(e),r.flags=c(e),r},importHeader:function(e){if(1316516640!=c(e))return null;var r={};return r.version=c(e),r.verticesCount=f(e),r.facesCount=f(e),r.signature=this.importSignature(e),r.nodesCount=c(e),r.patchesCount=c(e),r.texturesCount=c(e),r.sphere={center:[d(e),d(e),d(e)],radius:d(e)},r}},Instance=function(e){this.gl=e,this.onLoad=function(){},this.onUpdate=null,this.drawBudget=5242880,this.attributes={position:0,normal:1,color:2,uv:3,size:4,map:0}},Instance.prototype={open:function(e){var r=this;r.context=T(r.gl),r.modelMatrix=new Float32Array(16),r.viewMatrix=new Float32Array(16),r.projectionMatrix=new Float32Array(16),r.modelView=new Float32Array(16),r.modelViewInv=new Float32Array(16),r.modelViewProj=new Float32Array(16),r.modelViewProjInv=new Float32Array(16),r.planes=new Float32Array(24),r.viewport=new Float32Array(4),r.viewpoint=new Float32Array(4),r.context.meshes.forEach(function(t){t.url==e&&(r.mesh=t,r.renderMode=r.mesh.renderMode,r.mode=r.renderMode[0],r.onLoad())}),r.mesh||(r.mesh=new Mesh,r.mesh.onLoad=function(){r.renderMode=r.mesh.renderMode,r.mode=r.renderMode[0],r.onLoad()},r.mesh.open(e),r.context.meshes.push(r.mesh))},close:function(){},get isReady(){return this.mesh.isReady},setPrimitiveMode:function(e){this.mode=e},get datasetRadius(){return this.isReady?this.mesh.sphere.radius:1},get datasetCenter(){return this.isReady?this.mesh.sphere.center:[0,0,0]},updateView:function(e,r,t){for(var o,n,s,i=this,a=0;a<16;a++)i.projectionMatrix[a]=r[a],i.modelView[a]=t[a];for(a=0;a<4;a++)i.viewport[a]=e[a];o=i.projectionMatrix,n=i.modelView,(s=i.modelViewProj)[0]=o[0]*n[0]+o[4]*n[1]+o[8]*n[2]+o[12]*n[3],s[1]=o[1]*n[0]+o[5]*n[1]+o[9]*n[2]+o[13]*n[3],s[2]=o[2]*n[0]+o[6]*n[1]+o[10]*n[2]+o[14]*n[3],s[3]=o[3]*n[0]+o[7]*n[1]+o[11]*n[2]+o[15]*n[3],s[4]=o[0]*n[4]+o[4]*n[5]+o[8]*n[6]+o[12]*n[7],s[5]=o[1]*n[4]+o[5]*n[5]+o[9]*n[6]+o[13]*n[7],s[6]=o[2]*n[4]+o[6]*n[5]+o[10]*n[6]+o[14]*n[7],s[7]=o[3]*n[4]+o[7]*n[5]+o[11]*n[6]+o[15]*n[7],s[8]=o[0]*n[8]+o[4]*n[9]+o[8]*n[10]+o[12]*n[11],s[9]=o[1]*n[8]+o[5]*n[9]+o[9]*n[10]+o[13]*n[11],s[10]=o[2]*n[8]+o[6]*n[9]+o[10]*n[10]+o[14]*n[11],s[11]=o[3]*n[8]+o[7]*n[9]+o[11]*n[10]+o[15]*n[11],s[12]=o[0]*n[12]+o[4]*n[13]+o[8]*n[14]+o[12]*n[15],s[13]=o[1]*n[12]+o[5]*n[13]+o[9]*n[14]+o[13]*n[15],s[14]=o[2]*n[12]+o[6]*n[13]+o[10]*n[14]+o[14]*n[15],s[15]=o[3]*n[12]+o[7]*n[13]+o[11]*n[14]+o[15]*n[15],h(i.modelViewProj,i.modelViewProjInv),h(i.modelView,i.modelViewInv),i.viewpoint[0]=i.modelViewInv[12],i.viewpoint[1]=i.modelViewInv[13],i.viewpoint[2]=i.modelViewInv[14],i.viewpoint[3]=1;var u=i.modelViewProj,f=i.modelViewProjInv,c=i.planes;c[0]=u[0]+u[3],c[1]=u[4]+u[7],c[2]=u[8]+u[11],c[3]=u[12]+u[15],c[4]=-u[0]+u[3],c[5]=-u[4]+u[7],c[6]=-u[8]+u[11],c[7]=-u[12]+u[15],c[8]=u[1]+u[3],c[9]=u[5]+u[7],c[10]=u[9]+u[11],c[11]=u[13]+u[15],c[12]=-u[1]+u[3],c[13]=-u[5]+u[7],c[14]=-u[9]+u[11],c[15]=-u[13]+u[15],c[16]=-u[2]+u[3],c[17]=-u[6]+u[7],c[18]=-u[10]+u[11],c[19]=-u[14]+u[15],c[20]=-u[2]+u[3],c[21]=-u[6]+u[7],c[22]=-u[10]+u[11],c[23]=-u[14]+u[15];for(a=0;a<24;a+=4){var l=Math.sqrt(c[a]*c[a]+c[a+1]*c[a+1]+c[a+2]*c[a+2]);c[a]/=l,c[a+1]/=l,c[a+2]/=l,c[a+3]/=l}var d=f[3]+f[15],v=(f[0]+f[12])/d,p=(f[1]+f[13])/d,m=(f[2]+f[14])/d,x=-f[3]+f[15],b=(-f[0]+f[12])/x-v,A=(-f[1]+f[13])/x-p,E=(-f[2]+f[14])/x-m,g=Math.sqrt(b*b+A*A+E*E),R=f[12]/f[15]-i.viewpoint[0],w=f[13]/f[15]-i.viewpoint[1],y=f[14]/f[15]-i.viewpoint[2],T=2*g/Math.sqrt(R*R+w*w+y*y)/i.viewport[2];i.currentResolution==T?i.sameResolution=!0:i.sameResolution=!1,i.currentResolution=T},traversal:function(){var e=this;if(1!=v.extract){var r=e.mesh.nodesCount;if(e.sameResolution&&null!=e.selected){let t=!0;for(let o=0;o<r;o++)if(e.selected[o]&&0==e.mesh.status[o]){t=!1;break}if(t&&!e.visitQueue.size&&!e.nblocked)return}if(e.selected=new Uint8Array(r),e.isReady){e.visited=new Uint8Array(r),e.blocked=new Uint8Array(r),e.visitQueue=new PriorityQueue(r);for(var t=0;t<e.mesh.nroots;t++)e.insertNode(t);e.currentError=e.context.currentError,e.drawSize=0,e.nblocked=0;for(var o=0;e.visitQueue.size&&e.nblocked<3;){var n=e.visitQueue.error[0],s=e.visitQueue.pop();o<g&&0==e.mesh.status[s]&&(e.context.candidates.push({id:s,instance:e,mesh:e.mesh,frame:e.context.frame,error:n}),o++);let r=e.expandNode(s,n);var i="POINT"!=e.mode&&(e.blocked[s]||!r);i?e.nblocked++:e.selected[s]=1,e.insertChildren(s,i)}}}},insertNode:function(e){var r=this;r.visited[e]=1;var t=r.nodeError(e);if(!(e>0&&t<r.currentError)){var o=r.mesh.errors,n=r.mesh.frames;(n[e]!=r.context.frame||o[e]<t)&&(o[e]=t,n[e]=r.context.frame),r.visitQueue.push(e,t)}},insertChildren:function(e,r){for(var t=this,o=t.mesh.nfirstpatch[e];o<t.mesh.nfirstpatch[e+1];++o){var n=t.mesh.patches[3*o];if(n==t.mesh.sink)return;r&&(t.blocked[n]=1),t.visited[n]||t.insertNode(n)}},expandNode:function(e,r){var t=this;if(e>0&&r<t.currentError)return!1;if(t.drawSize>t.drawBudget)return!1;if(1!=t.mesh.status[e])return!1;var o=t.mesh.nspheres,n=5*e;return t.isVisible(o[n],o[n+1],o[n+2],o[n+3])&&(t.drawSize+=.8*t.mesh.nvertices[e]),!0},nodeError:function(e,r){var t=this,o=t.mesh.nspheres,n=t.viewpoint,s=5*e,i=o[s+0],a=o[s+1],u=o[s+2],f=o[s+3];r&&(f=o[s+4]);var c=n[0]-i,l=n[1]-a,d=n[2]-u,h=Math.sqrt(c*c+l*l+d*d)-f;h<.1&&(h=.1);var v=t.mesh.nerrors[e]/(t.currentResolution*h);return t.isVisible(i,a,u,o[s+4])||(v/=1e3),v},isVisible:function(r,t,o,n){var s=this.planes;for(e=0;e<24;e+=4)if(s[e]*r+s[e+1]*t+s[e+2]*o+s[e+3]+n<0)return!1;return!0},renderNodes:function(){var e=this,r=e.mesh,t=e.gl,o=e.attributes,n=t.getVertexAttrib(o.position,t.VERTEX_ATTRIB_ARRAY_ENABLED),s=o.normal>=0&&t.getVertexAttrib(o.normal,t.VERTEX_ATTRIB_ARRAY_ENABLED),i=o.color>=0&&t.getVertexAttrib(o.color,t.VERTEX_ATTRIB_ARRAY_ENABLED),a=o.uv>=0&&t.getVertexAttrib(o.uv,t.VERTEX_ATTRIB_ARRAY_ENABLED),u=0,f=-1;e.realError=0;for(var c=0;c<r.nodesCount;c++){if(!e.selected[c])continue;if("POINT"!=e.mode){for(var l=!0,d=r.nfirstpatch[c];d<r.nfirstpatch[c+1];d++){var h=r.patches[3*d];if(!e.selected[h]){l=!1;break}}if(l)continue}var p=r.nspheres,m=5*c;if(!e.isVisible(p[m],p[m+1],p[m+2],p[m+4]))continue;let n=e.nodeError(c,!0);e.realError=Math.max(n,e.realError),t.bindBuffer(t.ARRAY_BUFFER,r.vbo[c]),"POINT"!=e.mode&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r.ibo[c]),t.vertexAttribPointer(o.position,3,t.FLOAT,!1,12,0),t.enableVertexAttribArray(o.position);var x=r.nvertices[c],b=12*x;if(r.vertex.texCoord&&(o.uv>=0&&(t.vertexAttribPointer(o.uv,2,t.FLOAT,!1,8,b),t.enableVertexAttribArray(o.uv)),b+=8*x),r.vertex.color&&(o.color>=0&&(t.vertexAttribPointer(o.color,4,t.UNSIGNED_BYTE,!0,4,b),t.enableVertexAttribArray(o.color)),b+=4*x),r.vertex.normal&&o.normal>=0&&(t.vertexAttribPointer(o.normal,3,t.SHORT,!0,6,b),t.enableVertexAttribArray(o.normal)),v.nodes){t.disableVertexAttribArray(2),t.disableVertexAttribArray(3);var A=e.nodeError(c,!0),E=[[1,1,1,1],[1,1,1,1],[1,0,1,1],[0,1,1,1],[1,1,0,1],[0,0,1,1],[0,1,0,1],[1,0,0,1]];let r=Math.min(6.99,Math.max(0,Math.log2(A))),n=Math.floor(r);r-=n;let s=[];for(let e=0;e<4;e++)s[e]=E[n][e]*(1-r)+E[n+1][e]*r;t.vertexAttrib4fv(o.color,s)}if(!v.draw)if("POINT"!=e.mode){b=0;var g=0,R=r.nfirstpatch[c+1]-1;for(d=r.nfirstpatch[c];d<r.nfirstpatch[c+1];++d){h=r.patches[3*d];if(e.selected[h]||(g=r.patches[3*d+1],!(d<R))){if(g>b){if(r.vertex.texCoord)if(-1!=(T=r.patches[3*d+2])&&T!=f){U=r.texids[T];t.activeTexture(t.TEXTURE0+o.map),t.bindTexture(t.TEXTURE_2D,U),f=T}t.drawElements(t.TRIANGLES,3*(g-b),t.UNSIGNED_SHORT,6*b),u+=g-b}b=r.patches[3*d+1]}}}else{var w;w=e.pointsize?"number"==typeof e.pointsize?e.pointsize:e.pointsize():1,"object"==typeof o.size?(t.uniform1f(o.size,e.pointsize),t.uniform1f(o.scale,e.pointscale)):t.vertexAttrib1fv(o.size,[w]);var y=x;if(0!=y){var T;if(r.vertex.texCoord)if(-1!=(T=r.patches[3*r.nfirstpatch[c]+2])&&T!=f){var U=r.texids[T];t.activeTexture(t.TEXTURE0+o.map),t.bindTexture(t.TEXTURE_2D,U)}t.drawArrays(t.POINTS,0,y),u+=y}}}e.context.rendered+=u,e.context.realError=Math.max(e.context.realError,e.realError),n||t.disableVertexAttribArray(o.position),!s&&o.normal>=0&&t.disableVertexAttribArray(o.normal),!i&&o.color>=0&&t.disableVertexAttribArray(o.color),!a&&o.uv>=0&&t.disableVertexAttribArray(o.uv),t.bindBuffer(t.ARRAY_BUFFER,null),"POINT"!=e.mode&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)},render:function(){this.traversal(),this.renderNodes()}};var y=[];function T(e){var r=null;if(!e.isTexture)throw"Something wrong";return y.forEach(function(t){t.gl==e&&(r=t)}),r||(r={gl:e,meshes:[],frame:0,cacheSize:0,candidates:[],pending:0,maxCacheSize:w,minFps:E,targetError:b,currentError:b,maxError:A,realError:0},y.push(r),r)}function U(e,r){var t=r.id,o=r.mesh;if(0!=o.status[t]&&(v.verbose&&console.log("Removing "+o.url+" node: "+t),o.status[t]=0,t in o.georeq&&4!=o.georeq[t].readyState&&(o.georeq[t].abort(),e.pending--),e.cacheSize-=o.nsize[t],e.gl.deleteBuffer(o.vbo[t]),e.gl.deleteBuffer(o.ibo[t]),o.vbo[t]=o.ibo[t]=null,o.vertex.texCoord)){t in o.texreq&&4!=o.texreq[t].readyState&&o.texreq.abort();var n=o.patches[3*o.nfirstpatch[t]+2];o.texref[n]--,0==o.texref[n]&&o.texids[n]&&(e.gl.deleteTexture(o.texids[n]),o.texids[n]=null)}}function _(e,r){var t=r.id,n=r.mesh;n.status[t]++;let s={load:function(){delete n.georeq[t],function(e,r,t){var n=t.id,s=t.mesh;if(0==s.status[n])return;if(t.buffer=e.response,s.compressed)if(s.meco){for(var i={texcoords:s.vertex.texCoord,normals:s.vertex.normal,colors:s.vertex.color,indices:s.face.index},f=[],c=s.nfirstpatch[n];c<s.nfirstpatch[n+1];c++)f.push(s.patches[3*c+1]);a||((a=new Worker(o.replace("nexus.js","meco.js"))).onerror=function(e){console.log(e)},a.requests={},a.count=0,a.postRequest=function(e,r,t){var o={texcoords:e.texcoords?1:0,colors:e.colors?1:0,normals:e.normals?1:0,indices:e.indices?1:0};a.postMessage({signature:o,node:{nface:r.nface,nvert:r.nvert,buffer:r.buffer,request:this.count},patches:t}),r.buffer=null,this.requests[this.count++]=r},a.onmessage=function(e){var r=this.requests[e.data.request];delete this.requests[e.data.request],r.buffer=e.data.buffer,F(r)}),a.postRequest(i,t,f)}else u||((u=new Worker(o.replace("nexus.js","corto.em.js"))).requests={},u.count=0,u.postRequest=function(e){u.postMessage({buffer:e.buffer,request:this.count,rgba_colors:!0,short_index:!0,short_normals:!0}),e.buffer=null,this.requests[this.count++]=e},u.onmessage=function(e){var r=e.data.request,t=this.requests[r];delete this.requests[r],t.model=e.data.model,F(t)}),u.postRequest(t);else F(t)}(this,0,r)},error:function(){delete n.georeq[t],v.verbose&&console.log("Geometry request error!"),z(e,r,0)},abort:function(){delete n.georeq[t],v.verbose&&console.log("Geometry request abort!"),U(e,r)},type:"arraybuffer"};n.deepzoom?s.url=n.baseurl+t+".nxn":Object.assign(s,{url:n.url,start:n.noffsets[t],end:n.noffsets[t+1]}),n.georeq[t]=n.httpRequest(s)}function q(e,r){var t=r.id,o=r.mesh;if(!o.vertex.texCoord)return;var n=o.patches[3*o.nfirstpatch[t]+2];if(o.texref[n]++,o.texids[n])return;o.status[t]++;let s={load:function(){delete o.texreq[t],function(e,r,t,o){var n=t.id,s=t.mesh;if(0==s.status[n])return;var i=e.response,a=window.URL||window.webkitURL,u=document.createElement("img");u.onerror=function(e){console.log("Texture loading error!")},u.src=a.createObjectURL(i);var f=r.gl;u.onload=function(){a.revokeObjectURL(u.src);var e=f.getParameter(f.UNPACK_FLIP_Y_WEBGL);f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0);var r=s.texids[o]=f.createTexture();f.bindTexture(f.TEXTURE_2D,r);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,u);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),!(f instanceof WebGLRenderingContext)||I(u.width)&&I(u.height)?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST_MIPMAP_LINEAR),f.generateMipmap(f.TEXTURE_2D)):f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,e),s.status[n]--,2==s.status[n]&&(s.status[n]--,t.reqAttempt=0,t.context.pending--,t.instance.onUpdate&&t.instance.onUpdate(),M(f))}}(this,e,r,n)},error:function(){v.verbose&&console.log("Texture request error!"),delete o.texreq[t],z(e,r,1)},abort:function(){v.verbose&&console.log("Texture request abort!"),delete o.texreq[t],U(e,r)},type:"blob"};o.deepzoom?s.url=o.baseurl+n+".jpg":Object.assign(s,{url:o.url,start:o.textures[n],end:o.textures[n+1]}),o.texreq[t]=o.httpRequest(s)}function z(e,r,t){var o=r.id,n=r.mesh;if(0!=n.status[o]){if(n.status[o]--,r.reqAttempt>R)return v.verbose&&console.log("Max request limit for "+n.url+" node: "+o),void U(e,r);switch(r.reqAttempt++,t){case 0:_(e,r),v.verbose&&console.log("Recovering geometry for "+n.url+" node: "+o);break;case 1:q(e,r),v.verbose&&console.log("Recovering texture for "+n.url+" node: "+o)}}}function I(e){return e&&0==(e&e-1)}function F(e){var r,t,o=e.mesh,n=e.id,s=o.nvertices[n],i=o.nfaces[n],a=e.model;if(o.corto){t=e.model.index,r=new ArrayBuffer(s*o.vsize),(f=new Float32Array(r,0,3*s)).set(a.position);c=12*s;if(a.uv)(l=new Float32Array(r,c,2*s)).set(a.uv),c+=8*s;if(a.color)(h=new Uint8Array(r,c,4*s)).set(a.color),c+=4*s;if(a.normal)(d=new Int16Array(r,c,3*s)).set(a.normal);0==n&&(o.basev=new Float32Array(f.buffer,0,3*s),o.basei=t)}else{t=new Uint8Array(e.buffer,s*o.vsize,i*o.fsize),r=new Uint8Array(s*o.vsize);var u=new Uint8Array(e.buffer,0,s*o.vsize),f=u.subarray(0,12*s);r.set(f);var c=12*s;if(o.vertex.texCoord){var l=u.subarray(c,c+8*s);r.set(l,c),c+=8*s}if(o.vertex.normal&&o.vertex.color){var d=u.subarray(c,c+6*s),h=u.subarray(c+6*s,c+6*s+4*s);r.set(h,c),r.set(d,c+4*s)}else{if(o.vertex.normal){var d=u.subarray(c,c+6*s);r.set(d,c)}if(o.vertex.color){var h=u.subarray(c,c+4*s);r.set(h,c)}}0==n&&(o.basev=new Float32Array(r.buffer,0,3*s),o.basei=new Uint16Array(e.buffer,s*o.vsize,3*i))}0==i&&function(e,r,t,o){for(;e>0;){var n=Math.floor(Math.random()*e);e--;for(var s=0;s<3;s++){var i=r[3*e+s];r[3*e+s]=r[3*n+s],r[3*n+s]=i,t&&(i=t[3*e+s],t[3*e+s]=t[3*n+s],t[3*n+s]=i),o&&(i=o[4*e+s],o[4*e+s]=o[4*n+s],o[4*n+s]=i)}}}(s,f,d,h);var v=e.context.gl,p=o.vbo[n]=v.createBuffer();if(v.bindBuffer(v.ARRAY_BUFFER,p),v.bufferData(v.ARRAY_BUFFER,r,v.STATIC_DRAW),i>0){var m=o.ibo[n]=v.createBuffer();v.bindBuffer(v.ELEMENT_ARRAY_BUFFER,m),v.bufferData(v.ELEMENT_ARRAY_BUFFER,t,v.STATIC_DRAW)}o.status[n]--,2==o.status[n]&&(o.status[n]--,e.reqAttempt=0,e.context.pending--,e.instance.onUpdate&&e.instance.onUpdate(),M(v))}function M(r){var t=T(r),o=null;if(t.candidates.forEach(function(e){0==e.mesh.status[e.id]&&(!o||e.error>o.error)&&(o=e)}),t.candidates=[],o){for(;t.cacheSize>t.maxCacheSize;){var n=null;if(t.meshes.forEach(function(r){var t=r.nodesCount;for(e=0;e<t;e++)1==r.status[e]&&(!n||r.errors[e]<n.error)&&(n={error:r.errors[e],frame:r.frames[e],mesh:r,id:e})}),!n||n.error>=o.error&&n.frame==o.frame)return;U(t,n)}t.pending<g&&(!function(e,r){var t=r.id,o=r.mesh;o.status[t]=2,e.pending++,e.cacheSize+=o.nsize[t],r.reqAttempt=0,r.context=e,r.nvert=o.nvertices[t],r.nface=o.nfaces[t],_(e,r),q(e,r)}(t,o),M(r))}}return{Mesh:Mesh,Renderer:Instance,Renderable:Instance,Instance:Instance,Debug:v,contexts:y,beginFrame:function(e,r){var t=T(e);if(t.frame++,t.candidates=[],r&&t.minFps){t.currentFps=r;var o=t.minFps/r;o>1.1&&(t.currentError*=1.05),o<.9&&(t.currentError*=.95),t.currentError=Math.max(t.targetError,Math.min(t.maxError,t.currentError))}else t.currentError=t.targetError;t.rendered=0,t.realError=0},endFrame:function(e){M(e)},updateCache:M,flush:function(e,r){for(var t=0;t<r.nodesCount;t++)U(e,{mesh:r,id:t})},setTargetError:function(e,r){T(e).targetError=r},setMinFps:function(e,r){T(e).minFps=r},setMaxCacheSize:function(e,r){T(e).maxCacheSize=r},getTargetError:function(e){return T(e).targetError},getMinFps:function(e){return T(e).minFps},getMaxCacheSize:function(e){return T(e).maxCacheSize}}}();